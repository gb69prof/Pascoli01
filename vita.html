<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pascoli ‚Äî La vita</title>
  <meta name="description" content="Pascoli ‚Äî La vita: cronologia essenziale con approfondimenti e modalit√† lavoro (sottolinea, evidenzia, quaderno, export)." />

  <style>
    :root{
      --bg1:#fbf7ef;
      --bg2:#e9f6ff;
      --ink:#1f2a33;
      --muted:rgba(31,42,51,0.72);
      --quiet:rgba(31,42,51,0.56);
      --line:rgba(31,42,51,0.14);
      --card:rgba(255,255,255,0.72);
      --card2:rgba(255,255,255,0.90);
      --accent:#ffb703;
      --accent2:#219ebc;
      --shadow:0 18px 60px rgba(0,0,0,0.14);
      --r-xl:22px;
      --r-lg:16px;
      --max:1120px;

      --hl: rgba(255, 183, 3, 0.38);
      --ul: rgba(33, 158, 188, 0.75);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--ink);
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(33,158,188,0.18), transparent 62%),
        radial-gradient(820px 520px at 80% 18%, rgba(255,183,3,0.20), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      letter-spacing: .2px;
    }

    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width: var(--max); margin: 0 auto; padding: 22px 18px 28px; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap:wrap;
    }

    .crumbs{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 900;
      letter-spacing:.3px;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(31,42,51,0.14);
      background: rgba(255,255,255,0.88);
      font-size: 12px;
      font-weight: 950;
      user-select:none;
      transition: transform .14s ease, background .14s ease, border-color .14s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
      cursor:pointer;
    }
    .pill:hover{ transform: translateY(-1px); border-color: rgba(33,158,188,0.45); background: rgba(255,255,255,0.96); }
    .pill[aria-pressed="true"]{
      border-color: rgba(255,183,3,0.55);
      outline: 2px solid rgba(255,183,3,0.22);
      outline-offset: 2px;
      background: rgba(255,255,255,0.98);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      font-size: 11px;
      font-weight: 950;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(31,42,51,0.14);
      background: rgba(255,255,255,0.75);
      color: rgba(31,42,51,0.78);
      user-select:none;
    }

    .hero{
      border: 1px solid rgba(31,42,51,0.14);
      background: rgba(255,255,255,0.78);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow);
      overflow:hidden;
      padding: 14px 14px 12px;
      margin-bottom: 14px;
      position:relative;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(420px 220px at 18% 30%, rgba(255,183,3,0.18), transparent 60%),
        radial-gradient(420px 220px at 82% 20%, rgba(33,158,188,0.18), transparent 60%);
      pointer-events:none;
    }
    .heroInner{ position:relative; }
    .kicker{
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: rgba(31,42,51,0.72);
      font-weight: 900;
    }
    h1{
      margin: 6px 0 6px;
      font-size: clamp(26px, 4.2vw, 44px);
      line-height: 1.08;
      letter-spacing: .2px;
    }
    .subtitle{
      margin: 0;
      color: rgba(31,42,51,0.80);
      line-height: 1.55;
      font-size: 13px;
      max-width: 980px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 390px;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid rgba(31,42,51,0.14);
      background: var(--card);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .card .hd{
      padding: 12px 14px 10px;
      border-bottom: 1px solid rgba(31,42,51,0.10);
      background: linear-gradient(180deg, rgba(255,255,255,0.70), rgba(255,255,255,0.25));
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .card .hd strong{
      font-size: 12px;
      letter-spacing: .9px;
      text-transform: uppercase;
      color: rgba(31,42,51,0.76);
    }
    .card .bd{ padding: 14px; }

    .prose p{
      margin: 0 0 10px;
      line-height: 1.7;
      font-size: 14px;
      color: rgba(31,42,51,0.86);
    }
    .prose p:last-child{ margin-bottom:0; }

    .noteBox{
      margin-top: 12px;
      border: 1px dashed rgba(31,42,51,0.22);
      background: rgba(255,255,255,0.72);
      border-radius: 16px;
      padding: 10px 12px;
    }
    .noteBox .t{
      font-weight: 950; font-size: 12px; letter-spacing: .7px; text-transform: uppercase;
      color: rgba(31,42,51,0.70);
      margin-bottom: 6px;
    }
    .noteBox .b{
      font-size: 13px; line-height:1.55; color: rgba(31,42,51,0.84);
    }

    .workTools{ display:none; gap: 8px; flex-wrap:wrap; align-items:center; }
    .workOn .workTools{ display:flex; }

    .toolBtn{
      appearance:none;
      border: 1px solid rgba(31,42,51,0.14);
      background: rgba(255,255,255,0.92);
      font-weight: 950;
      border-radius: 999px;
      padding: 8px 10px;
      cursor:pointer;
      transition: transform .14s ease, background .14s ease, border-color .14s ease;
      user-select:none;
      font-size: 12px;
      touch-action: manipulation;
    }
    .toolBtn:hover{ transform: translateY(-1px); border-color: rgba(255,183,3,0.45); background: rgba(255,255,255,1); }
    .toolBtn:disabled{ opacity: .55; cursor:not-allowed; transform:none; }

    .tip{
      font-size:12px;
      color: rgba(31,42,51,0.66);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(31,42,51,0.12);
      background: rgba(255,255,255,0.62);
      user-select:none;
    }

    .mark{
      border-radius: 6px;
      padding: 0 .08em;
      -webkit-box-decoration-break: clone;
      box-decoration-break: clone;
    }
    .mark.hl{ background: var(--hl); }
    .mark.ul{
      background: rgba(255,255,255,0.0);
      text-decoration: underline;
      text-decoration-thickness: 3px;
      text-decoration-color: var(--ul);
      text-underline-offset: 3px;
    }

    .notebook{
      margin-top: 14px;
      border: 1px solid rgba(31,42,51,0.12);
      background: rgba(255,255,255,0.82);
      border-radius: 18px;
      padding: 12px 12px 10px;
    }
    .notebookHd{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom: 8px;
    }
    .notebookHd b{
      font-size: 12px; letter-spacing: .9px; text-transform: uppercase;
      color: rgba(31,42,51,0.76);
    }
    .nbActions{ display:flex; gap:8px; flex-wrap:wrap; }
    .nbBox{
      border: 1px dashed rgba(31,42,51,0.18);
      border-radius: 14px;
      padding: 10px 10px;
      background: rgba(255,255,255,0.70);
      min-height: 70px;
      white-space: pre-wrap;
      line-height: 1.55;
      font-size: 13px;
      color: rgba(31,42,51,0.88);
    }
    .nbMeta{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(31,42,51,0.62);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }

    .timeline{ display:flex; flex-direction:column; gap: 10px; }
    .tItem{
      width:100%;
      text-align:left;
      border: 1px solid rgba(31,42,51,0.12);
      background: rgba(255,255,255,0.82);
      border-radius: 16px;
      padding: 10px 10px;
      cursor:pointer;
      transition: transform .14s ease, background .14s ease, border-color .14s ease;
      position:relative;
      overflow:hidden;
    }
    .tItem:hover{
      transform: translateY(-1px);
      border-color: rgba(255,183,3,0.45);
      background: rgba(255,255,255,0.94);
    }
    .tRow{ display:flex; align-items:flex-start; justify-content:space-between; gap: 10px; }
    .tDate{ font-weight: 950; font-size: 12px; letter-spacing:.6px; color: rgba(31,42,51,0.72); white-space:nowrap; }
    .tTitle{ font-weight: 950; font-size: 13px; color: rgba(31,42,51,0.90); margin: 0 0 3px; }
    .tMini{ font-size: 12px; color: rgba(31,42,51,0.70); line-height: 1.45; }
    .tChevron{ color: rgba(33,158,188,0.95); font-weight: 950; margin-left: 8px; }

    footer{ margin-top: 16px; font-size: 12px; color: var(--quiet); }

    dialog{
      border: none;
      padding: 0;
      width: min(920px, calc(100vw - 22px));
      border-radius: 18px;
      box-shadow: 0 25px 80px rgba(0,0,0,0.24);
      background: rgba(255,255,255,0.98);
      overflow:hidden;
    }
    dialog::backdrop{
      background: rgba(10,16,22,0.45);
      backdrop-filter: blur(2px);
    }
    .modalHd{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(31,42,51,0.12);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      background:
        radial-gradient(520px 240px at 20% 30%, rgba(255,183,3,0.18), transparent 60%),
        radial-gradient(520px 240px at 80% 30%, rgba(33,158,188,0.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.80));
    }
    .modalTitle{ margin:0; font-size: 16px; font-weight: 950; color: rgba(31,42,51,0.92); line-height: 1.25; }
    .modalSub{ margin: 6px 0 0; font-size: 12px; color: rgba(31,42,51,0.74); line-height:1.45; max-width: 72ch; }
    .closeBtn{
      appearance:none;
      border: 1px solid rgba(31,42,51,0.14);
      background: rgba(255,255,255,0.92);
      font-weight: 950;
      border-radius: 999px;
      padding: 8px 10px;
      cursor:pointer;
      transition: transform .14s ease, background .14s ease, border-color .14s ease;
      user-select:none;
      white-space:nowrap;
    }
    .closeBtn:hover{ transform: translateY(-1px); border-color: rgba(33,158,188,0.45); background: rgba(255,255,255,1); }
    .modalBd{ padding: 12px 14px 14px; }

    .tabs{ display:flex; gap: 8px; flex-wrap:wrap; margin-bottom: 10px; }
    .tabBtn{
      appearance:none;
      border: 1px solid rgba(31,42,51,0.14);
      background: rgba(255,255,255,0.88);
      padding: 9px 10px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 950;
      font-size: 12px;
      transition: transform .14s ease, background .14s ease, border-color .14s ease;
      user-select:none;
    }
    .tabBtn:hover{ transform: translateY(-1px); border-color: rgba(255,183,3,0.45); background: rgba(255,255,255,0.96); }
    .tabBtn[aria-selected="true"]{
      border-color: rgba(33,158,188,0.45);
      outline: 2px solid rgba(33,158,188,0.25);
      outline-offset: 2px;
      background: rgba(233,246,255,0.72);
    }
    .panel{
      border: 1px solid rgba(31,42,51,0.12);
      background: rgba(255,255,255,0.82);
      border-radius: 16px;
      padding: 10px 10px;
    }
    .panel p{ margin: 0 0 10px; line-height: 1.65; font-size: 13px; color: rgba(31,42,51,0.86); }
    .panel p:last-child{ margin-bottom:0; }

    .links{ display:flex; flex-wrap:wrap; gap: 8px; margin-top: 10px; }
    .chipLink{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(31,42,51,0.14);
      background: rgba(255,255,255,0.88);
      font-size: 12px;
      font-weight: 950;
      cursor:pointer;
      transition: transform .14s ease, background .14s ease, border-color .14s ease;
    }
    .chipLink:hover{
      transform: translateY(-1px);
      border-color: rgba(255,183,3,0.45);
      background: rgba(255,255,255,0.96);
    }

    @media (prefers-reduced-motion: reduce){ *{ transition:none !important; } }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="crumbs">
        <span class="badge">üü¢ OSSATURA</span>
        <span class="badge" id="badgeWork" style="display:none;">üü° LAVORO</span>
        <span style="color:rgba(31,42,51,0.72); font-weight:900;">Pascoli</span>
        <span style="color:rgba(31,42,51,0.45);">/</span>
        <span style="font-weight:950;">La vita</span>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button class="pill" id="toggleWork" type="button" aria-pressed="false" title="Attiva/Disattiva strumenti di lavoro">
          üü° Modalit√† lavoro: OFF
        </button>
        <a class="pill" href="index.html" aria-label="Torna alla home">‚Ü©Ô∏é Home</a>
      </div>
    </div>

    <section class="hero" aria-label="Introduzione">
      <div class="heroInner">
        <div class="kicker">Cronologia essenziale + approfondimenti + intervento sul testo</div>
        <h1>La vita (senza museo)</h1>
        <p class="subtitle">
          A destra c‚Äô√® la cronologia essenziale. A sinistra puoi leggere e, se attivi la <b>Modalit√† lavoro</b>,
          puoi <b>sottolineare</b>, <b>evidenziare</b> e <b>ricavare un testo</b> da salvare.
        </p>
      </div>
    </section>

    <section class="grid" aria-label="Vita Pascoli: testo e timeline">

      <!-- SINISTRA -->
      <article class="card" aria-label="Sintesi della vita">
        <div class="hd">
          <strong>Sintesi (chiara, non cupa)</strong>

          <div class="workTools" aria-label="Strumenti di lavoro">
            <button class="toolBtn" id="btnUnderline" type="button" disabled>‚úèÔ∏è Sottolinea</button>
            <button class="toolBtn" id="btnHighlight" type="button" disabled>üñçÔ∏è Evidenzia</button>
            <button class="toolBtn" id="btnUndo" type="button" disabled>‚Ü©Ô∏é Annulla</button>
            <button class="toolBtn" id="btnClearMarks" type="button" disabled>üßº Pulisci segni</button>
            <span class="tip" id="workTip">Seleziona una frase e premi un pulsante.</span>
          </div>
        </div>

        <div class="bd prose" id="workArea">
          <div id="workText">
            <p>
              Giovanni Pascoli nasce a San Mauro di Romagna nel 1855. L‚Äôinfanzia viene spezzata dall‚Äôassassinio del padre Ruggero (10 agosto 1867) e,
              negli anni immediatamente successivi, da una serie di lutti familiari. Da questa frattura nasce l‚Äôidea del <b>nido</b> come bisogno vitale:
              non un tema ‚Äúcarino‚Äù, ma un modo di sopravvivere al mondo.
            </p>
            <p>
              Studia in collegio (Urbino) e poi a Bologna, allievo di Carducci. Gli anni universitari sono agitati: partecipa a movimenti e proteste,
              perde la borsa di studio e subisce anche il carcere. Pi√π tardi torna agli studi e si laurea.
            </p>
            <p>
              Inizia a insegnare e costruisce la propria vita attorno a un equilibrio fragile ma tenace: le sorelle, soprattutto Maria (‚ÄúMari√π‚Äù).
              Quando Ida si sposa, Pascoli vive la cosa come un abbandono: non √® un dettaglio sentimentale, √® struttura psicologica.
            </p>
            <p>
              Ottiene incarichi universitari importanti (Messina, poi Bologna) e nel 1903 succede a Carducci.
              Ma la vera dimora, per lui, √® Castelvecchio di Barga: campagna, natura, suoni, cose minime. Muore nel 1912 a Bologna.
            </p>

            <div class="noteBox">
              <div class="t">Come usare questa pagina</div>
              <div class="b">
                Se vuoi solo orientarti: leggi e basta. Se vuoi allenarti: attiva <b>Modalit√† lavoro</b>,
                marca 2‚Äì3 frasi e poi fai <b>Ricava testo</b>.
              </div>
            </div>
          </div>

          <!-- Quaderno -->
          <div class="notebook" aria-label="Quaderno dal lavoro">
            <div class="notebookHd">
              <b>üü° Quaderno (dal tuo lavoro)</b>
              <div class="nbActions">
                <button class="toolBtn" id="btnExtract" type="button" disabled>üìå Ricava testo</button>
                <button class="toolBtn" id="btnCopy" type="button" disabled>üìã Copia</button>
                <button class="toolBtn" id="btnSaveTxt" type="button" disabled>üíæ Salva .txt</button>
                <button class="toolBtn" id="btnClearNotebook" type="button" disabled>üßΩ Svuota quaderno</button>
              </div>
            </div>

            <div class="nbBox" id="notebookText" aria-live="polite"></div>
            <div class="nbMeta">
              <span id="nbCount">0 righe</span>
              <span id="saveState">autosave: ‚Äî</span>
            </div>
          </div>

        </div>
      </article>

      <!-- DESTRA -->
      <aside class="card" aria-label="Cronologia essenziale">
        <div class="hd">
          <strong>Cronologia essenziale</strong>
          <span class="badge">tocca ‚Üí approfondisci</span>
        </div>
        <div class="bd">
          <div class="timeline" id="timeline"></div>

          <div style="margin-top:12px; font-size:12px; color:rgba(31,42,51,0.62); line-height:1.5;">
            Nota: i collegamenti ‚Äúpoesie‚Äù sono proposti come ponte didattico (puoi cambiarli).
          </div>
        </div>
      </aside>

    </section>

    <footer>¬© <span id="year"></span> ‚Äî Pascoli / Libro.0 ‚Äî a cura di gbprof</footer>
  </div>

  <!-- MODAL -->
  <dialog id="modal">
    <div class="modalHd">
      <div>
        <h2 class="modalTitle" id="mTitle">Titolo</h2>
        <p class="modalSub" id="mSub">Sottotitolo</p>
      </div>
      <button class="closeBtn" id="mClose" type="button" aria-label="Chiudi">‚úï Chiudi</button>
    </div>
    <div class="modalBd">
      <div class="tabs" role="tablist" aria-label="Approfondimenti">
        <button class="tabBtn" id="tabWorld" type="button" role="tab" aria-selected="true" aria-controls="panelWorld">
          1) Immagine del mondo
        </button>
        <button class="tabBtn" id="tabPoems" type="button" role="tab" aria-selected="false" aria-controls="panelPoems">
          2) Poesie collegate
        </button>
      </div>

      <div class="panel" id="panelWorld" role="tabpanel" aria-labelledby="tabWorld"></div>
      <div class="panel" id="panelPoems" role="tabpanel" aria-labelledby="tabPoems" hidden></div>
    </div>
  </dialog>

  <script>
    const $ = (q, r=document) => r.querySelector(q);

    // Year
    $('#year').textContent = new Date().getFullYear();

    // =========
    //  TIMELINE DATA
    // =========
    const EVENTS = [
      { date:"1855", title:"Nasce a San Mauro di Romagna", mini:"Origine rurale, ‚Äúcose‚Äù e natura come alfabeti.",
        sub:"31 dicembre 1855: famiglia numerosa, benessere rurale moderato.",
        world:`<p>L‚Äôinizio √® lessico: le cose minime diventano lingua.</p>`,
        poems:[{label:"Myricae (cornice)", href:"#", note:"Natura, suoni, frammenti."}]
      },
      { date:"1867", title:"Assassinio del padre (10 agosto)", mini:"La frattura: trauma e domanda senza risposta.",
        sub:"10 agosto 1867: Ruggero Pascoli ucciso in un agguato; omicidio impunito.",
        world:`<p>La realt√† pu√≤ essere ingiusta senza spiegazione: esperienza, non teoria.</p>`,
        poems:[{label:"X agosto", href:"testi/x-agosto.html", note:"Nodo sorgivo."}]
      },
      { date:"1868‚Äì1871", title:"Catena di lutti familiari", mini:"Il guscio si rompe: nasce il bisogno del nido.",
        sub:"Negli anni successivi muoiono madre, sorella e fratelli.",
        world:`<p>Il nido √® difesa, ricostruzione, rito.</p>`,
        poems:[{label:"Tema: il nido (pagina futura)", href:"#", note:"Crea pagina-tema."}]
      },
      { date:"1873‚Äì1882", title:"Bologna: Carducci, politica, inquietudine", mini:"Protesta, perdita borsa, carcere.",
        sub:"1876 perdita borsa; 1879 carcere; 1882 laurea.",
        world:`<p>Conflitto e storia: energia che diventa tensione interna.</p>`,
        poems:[{label:"Poemi conviviali (se li accenni)", href:"#", note:"Ponte classico/moderno."}]
      },
      { date:"1895", title:"Ida si sposa: ferita affettiva", mini:"Vissuto come abbandono.",
        sub:"Evento privato ma strutturante.",
        world:`<p>Il fanciullino √® vulnerabilit√† che non si chiude.</p>`,
        poems:[{label:"Il gelsomino notturno", href:"testi/gelsomino-notturno.html", note:"Soglia/intimit√†."}]
      },
      { date:"1912", title:"Muore a Bologna (6 aprile)", mini:"Vita e opera inseparabili.",
        sub:"6 aprile 1912: morte; sepolto a Castelvecchio.",
        world:`<p>Pascoli √® una risposta poetica a una frattura originaria.</p>`,
        poems:[{label:"Ripasso: X agosto", href:"testi/x-agosto.html", note:"Nodo sorgivo."}]
      }
    ];

    // Render timeline
    const tl = $('#timeline');
    EVENTS.forEach((ev) => {
      const btn = document.createElement('button');
      btn.type = "button";
      btn.className = "tItem";
      btn.innerHTML = `
        <div class="tRow">
          <div style="min-width:0;">
            <div class="tTitle">${escapeHTML(ev.title)}</div>
            <div class="tMini">${escapeHTML(ev.mini)}</div>
          </div>
          <div style="display:flex; align-items:flex-start;">
            <div class="tDate">${escapeHTML(ev.date)}</div>
            <div class="tChevron">‚Ä∫</div>
          </div>
        </div>
      `;
      btn.addEventListener('click', () => openModal(ev));
      tl.appendChild(btn);
    });

    // =========
    //  MODAL
    // =========
    const modal = $('#modal');
    const mTitle = $('#mTitle');
    const mSub = $('#mSub');
    const panelWorld = $('#panelWorld');
    const panelPoems = $('#panelPoems');
    const tabWorld = $('#tabWorld');
    const tabPoems = $('#tabPoems');

    function setTab(which){
      const isWorld = which === 'world';
      tabWorld.setAttribute('aria-selected', isWorld ? 'true' : 'false');
      tabPoems.setAttribute('aria-selected', isWorld ? 'false' : 'true');
      panelWorld.hidden = !isWorld;
      panelPoems.hidden = isWorld;
    }
    tabWorld.addEventListener('click', () => setTab('world'));
    tabPoems.addEventListener('click', () => setTab('poems'));

    $('#mClose').addEventListener('click', () => modal.close());
    modal.addEventListener('click', (e) => {
      const rect = modal.getBoundingClientRect();
      const inDialog =
        e.clientX >= rect.left && e.clientX <= rect.right &&
        e.clientY >= rect.top && e.clientY <= rect.bottom;
      if(!inDialog) modal.close();
    });

    function openModal(ev){
      mTitle.textContent = `${ev.date} ‚Äî ${ev.title}`;
      mSub.textContent = ev.sub || "";
      panelWorld.innerHTML = ev.world || "<p>(da completare)</p>";
      panelPoems.innerHTML = `
        <p style="margin:0 0 8px; font-weight:950;">Collegamenti consigliati:</p>
        ${renderPoems(ev.poems || [])}
      `;
      setTab('world');
      if(typeof modal.showModal === "function") modal.showModal();
      else alert("Il tuo browser non supporta i dialog.");
    }

    function renderPoems(list){
      if(!list.length) return `<p>Nessun collegamento impostato.</p>`;
      const chips = list.map(p => {
        const href = p.href || "#";
        const label = escapeHTML(p.label || "link");
        const title = escapeHTML(p.note || "");
        return `<a class="chipLink" href="${href}" title="${title}">üìé ${label}</a>`;
      }).join("");
      return `<div class="links">${chips}</div>`;
    }

    function escapeHTML(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // =========
    //  LAVORO (FIX robusto)
    // =========
    const toggleWork = $('#toggleWork');
    const badgeWork = $('#badgeWork');
    const btnUnderline = $('#btnUnderline');
    const btnHighlight = $('#btnHighlight');
    const btnUndo = $('#btnUndo');
    const btnClearMarks = $('#btnClearMarks');
    const btnExtract = $('#btnExtract');
    const btnCopy = $('#btnCopy');
    const btnSaveTxt = $('#btnSaveTxt');
    const btnClearNotebook = $('#btnClearNotebook');
    const workTip = $('#workTip');

    const workText = $('#workText');
    const notebookText = $('#notebookText');
    const nbCount = $('#nbCount');
    const saveState = $('#saveState');

    let workEnabled = false;

    // Range cache: salva l‚Äôultima selezione valida (fondamentale su iPad)
    let cachedRange = null;

    // Undo stack (snapshot HTML)
    const undoStack = [];
    const UNDO_MAX = 25;

    // Notebook lines
    let notebookLines = [];

    // Storage (IndexedDB + fallback)
    const DB_NAME = "Libro01_Pascoli";
    const DB_STORE = "pages";
    const PAGE_KEY = "vita";

    function setSaveState(msg){ saveState.textContent = "autosave: " + msg; }

    function pushUndo(){
      undoStack.push(workText.innerHTML);
      if(undoStack.length > UNDO_MAX) undoStack.shift();
      btnUndo.disabled = !(workEnabled && undoStack.length > 0);
    }

    function enableWorkUI(on){
      workEnabled = on;
      document.body.classList.toggle('workOn', on);
      badgeWork.style.display = on ? "inline-flex" : "none";
      toggleWork.setAttribute('aria-pressed', on ? "true" : "false");
      toggleWork.textContent = on ? "üü° Modalit√† lavoro: ON" : "üü° Modalit√† lavoro: OFF";

      const dis = !on;
      btnUnderline.disabled = dis;
      btnHighlight.disabled = dis;
      btnClearMarks.disabled = dis;
      btnExtract.disabled = dis;
      btnUndo.disabled = !(on && undoStack.length > 0);

      updateNotebookUI();

      workTip.textContent = on
        ? "Seleziona una frase e poi premi Sottolinea/Evidenzia."
        : "Modalit√† lettura: pulita. (Attiva lavoro se vuoi intervenire.)";
    }

    toggleWork.addEventListener('click', () => enableWorkUI(!workEnabled));

    // IMPORTANTISSIMO: su iPad il click sul bottone ‚Äúuccide‚Äù la selezione.
    // Quindi blocchiamo il focus sul bottone e usiamo la selezione cache.
    [btnUnderline, btnHighlight, btnUndo, btnClearMarks, btnExtract, btnCopy, btnSaveTxt, btnClearNotebook].forEach(b=>{
      b.addEventListener('pointerdown', (e)=>{ if(workEnabled) e.preventDefault(); }, {passive:false});
      b.addEventListener('mousedown', (e)=>{ if(workEnabled) e.preventDefault(); });
      b.addEventListener('touchstart', (e)=>{ if(workEnabled) e.preventDefault(); }, {passive:false});
    });

    function isRangeInside(range, container){
      if(!range) return false;
      const common = range.commonAncestorContainer;
      const node = common.nodeType === 1 ? common : common.parentNode;
      return container.contains(node);
    }

    function captureSelection(){
      if(!workEnabled) return;
      const sel = window.getSelection();
      if(!sel || sel.rangeCount === 0) return;
      const r = sel.getRangeAt(0);
      if(r.collapsed) return;
      if(!isRangeInside(r, workText)) return;

      // clona e salva
      cachedRange = r.cloneRange();
      workTip.textContent = "Selezione pronta ‚Üí scegli Sottolinea o Evidenzia.";
    }

    document.addEventListener('selectionchange', captureSelection);

    // Helper per TreeWalker text nodes nel range
    function getTextNodesInRange(range, container){
      const nodes = [];
      const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, {
        acceptNode(node){
          if(!node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
          // Interseca range?
          const nodeRange = document.createRange();
          nodeRange.selectNodeContents(node);
          const intersects =
            range.compareBoundaryPoints(Range.END_TO_START, nodeRange) < 0 &&
            range.compareBoundaryPoints(Range.START_TO_END, nodeRange) > 0;
          return intersects ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;
        }
      });
      let n;
      while((n = walker.nextNode())) nodes.push(n);
      return nodes;
    }

    function normText(t){ return t.replace(/\s+/g, " ").trim(); }

    function wrapTextPortion(textNode, start, end, className){
      const text = textNode.nodeValue;
      const before = text.slice(0, start);
      const mid = text.slice(start, end);
      const after = text.slice(end);

      const frag = document.createDocumentFragment();
      if(before) frag.appendChild(document.createTextNode(before));

      const span = document.createElement('span');
      span.className = "mark " + className;
      span.setAttribute('data-mark', className === "ul" ? "ul" : "hl");
      span.setAttribute('data-ts', String(Date.now()));
      span.textContent = mid;
      frag.appendChild(span);

      if(after) frag.appendChild(document.createTextNode(after));

      textNode.parentNode.replaceChild(frag, textNode);
    }

    function applyMarkRobust(kind){
      if(!workEnabled) return;

      // usa cachedRange se disponibile, altrimenti prova a leggere selezione live
      let range = cachedRange && isRangeInside(cachedRange, workText) ? cachedRange.cloneRange() : null;

      if(!range){
        const sel = window.getSelection();
        if(sel && sel.rangeCount){
          const r2 = sel.getRangeAt(0);
          if(!r2.collapsed && isRangeInside(r2, workText)) range = r2.cloneRange();
        }
      }

      if(!range || range.collapsed){
        flashTip("Seleziona prima una frase nel testo (colonna sinistra).");
        return;
      }

      // evita di marcare gi√† dentro un mark: se la selezione √® tutta dentro mark, non fare casino
      const sc = range.startContainer.nodeType === 1 ? range.startContainer : range.startContainer.parentNode;
      const ec = range.endContainer.nodeType === 1 ? range.endContainer : range.endContainer.parentNode;
      if(sc && sc.closest && sc.closest('.mark') && ec && ec.closest && ec.closest('.mark')){
        flashTip("Sei gi√† dentro un segno. Seleziona un po‚Äô pi√π fuori.");
        return;
      }

      pushUndo();

      try{
        const nodes = getTextNodesInRange(range, workText);
        if(nodes.length === 0){
          flashTip("Selezione non valida. Prova a selezionare solo testo (non spazi).");
          return;
        }

        // Processa dal fondo verso l‚Äôalto per non rompere gli offset dei nodi successivi
        for(let i = nodes.length - 1; i >= 0; i--){
          const node = nodes[i];
          const nodeRange = document.createRange();
          nodeRange.selectNodeContents(node);

          const start = (node === range.startContainer) ? range.startOffset : 0;
          const end = (node === range.endContainer) ? range.endOffset : node.nodeValue.length;

          // clamp
          const s = Math.max(0, Math.min(start, node.nodeValue.length));
          const e = Math.max(0, Math.min(end, node.nodeValue.length));
          if(e <= s) continue;

          wrapTextPortion(node, s, e, kind);
        }

        // pulisci selezione cache (evita riapplicazioni strane)
        cachedRange = null;
        const sel = window.getSelection();
        if(sel) sel.removeAllRanges();

        autosaveNow();
        btnUndo.disabled = !(workEnabled && undoStack.length > 0);
        flashTip(kind === "ul" ? "Sottolineatura fatta." : "Evidenziazione fatta.");
      }catch(err){
        // rollback
        if(undoStack.length){
          workText.innerHTML = undoStack.pop();
        }
        btnUndo.disabled = !(workEnabled && undoStack.length > 0);
        flashTip("Safari ha fatto resistenza. Seleziona una frase pi√π corta e riprova.");
      }
    }

    btnUnderline.addEventListener('click', () => applyMarkRobust('ul'));
    btnHighlight.addEventListener('click', () => applyMarkRobust('hl'));

    btnUndo.addEventListener('click', () => {
      if(!workEnabled || undoStack.length === 0) return;
      workText.innerHTML = undoStack.pop();
      autosaveNow();
      btnUndo.disabled = !(workEnabled && undoStack.length > 0);
      flashTip("Annullato.");
    });

    btnClearMarks.addEventListener('click', () => {
      if(!workEnabled) return;
      pushUndo();
      const marks = workText.querySelectorAll('.mark');
      marks.forEach(m => {
        const parent = m.parentNode;
        while(m.firstChild) parent.insertBefore(m.firstChild, m);
        parent.removeChild(m);
        parent.normalize();
      });
      autosaveNow();
      btnUndo.disabled = !(workEnabled && undoStack.length > 0);
      flashTip("Segni rimossi (testo intatto).");
    });

    btnExtract.addEventListener('click', () => {
      if(!workEnabled) return;
      const marks = Array.from(workText.querySelectorAll('.mark'));
      if(marks.length === 0){
        flashTip("Non hai ancora segnato nulla.");
        return;
      }

      const lines = [];
      marks.forEach((m) => {
        const t = normText(m.textContent || "");
        if(!t) return;
        const tag = m.classList.contains('hl') ? "EVID" : "SOTT";
        lines.push(`[${tag}] ${t}`);
      });

      notebookLines = dedupePreserveOrder(lines);
      renderNotebook();
      autosaveNow();
      flashTip("Quaderno aggiornato.");
    });

    function dedupePreserveOrder(arr){
      const seen = new Set();
      const out = [];
      for(const x of arr){
        if(seen.has(x)) continue;
        seen.add(x);
        out.push(x);
      }
      return out;
    }

    function renderNotebook(){
      notebookText.textContent = notebookLines.join("\n");
      nbCount.textContent = `${notebookLines.length} righe`;
      updateNotebookUI();
    }

    function updateNotebookUI(){
      const has = notebookLines.length > 0;
      btnCopy.disabled = !has;
      btnSaveTxt.disabled = !has;
      btnClearNotebook.disabled = !has;
    }

    btnClearNotebook.addEventListener('click', () => {
      notebookLines = [];
      renderNotebook();
      autosaveNow();
      flashTip("Quaderno svuotato.");
    });

    btnCopy.addEventListener('click', async () => {
      const txt = notebookLines.join("\n");
      try{
        await navigator.clipboard.writeText(txt);
        flashTip("Copiato.");
      }catch(e){
        const ta = document.createElement('textarea');
        ta.value = txt;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        flashTip("Copiato.");
      }
    });

    btnSaveTxt.addEventListener('click', () => {
      const txt = notebookLines.join("\n");
      const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Pascoli_vita_quaderno_${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 800);
      flashTip("File .txt salvato.");
    });

    let tipTimer = null;
    function flashTip(msg){
      const old = workTip.textContent;
      workTip.textContent = msg;
      workTip.style.borderColor = "rgba(255,183,3,0.55)";
      workTip.style.background = "rgba(255,255,255,0.92)";
      clearTimeout(tipTimer);
      tipTimer = setTimeout(() => {
        workTip.textContent = workEnabled ? "Seleziona una frase e poi premi Sottolinea/Evidenzia." : "Modalit√† lettura: pulita. (Attiva lavoro se vuoi intervenire.)";
        workTip.style.borderColor = "rgba(31,42,51,0.12)";
        workTip.style.background = "rgba(255,255,255,0.62)";
      }, 1600);
    }

    // =========
    //  AUTOSAVE (IndexedDB + fallback localStorage)
    // =========
    async function idbOpen(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = () => {
          const db = req.result;
          if(!db.objectStoreNames.contains(DB_STORE)){
            db.createObjectStore(DB_STORE);
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function idbSet(key, value){
      const db = await idbOpen();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(DB_STORE, "readwrite");
        tx.objectStore(DB_STORE).put(value, key);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => reject(tx.error);
      });
    }

    async function idbGet(key){
      const db = await idbOpen();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(DB_STORE, "readonly");
        const req = tx.objectStore(DB_STORE).get(key);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    function lsKey(){ return "Libro01_Pascoli_vita_v2"; }

    async function autosaveNow(){
      const payload = {
        v: 2,
        ts: Date.now(),
        workHTML: workText.innerHTML,
        notebook: notebookLines
      };

      try{
        await idbSet(PAGE_KEY, payload);
        setSaveState("OK (IndexedDB)");
      }catch(e){
        try{
          localStorage.setItem(lsKey(), JSON.stringify(payload));
          setSaveState("OK (localStorage)");
        }catch(err){
          setSaveState("errore");
        }
      }
    }

    async function restoreIfAny(){
      let data = null;
      try{ data = await idbGet(PAGE_KEY); }catch(e){}
      if(!data){
        try{
          const raw = localStorage.getItem(lsKey());
          if(raw) data = JSON.parse(raw);
        }catch(e){}
      }

      if(data && data.workHTML) workText.innerHTML = data.workHTML;
      if(data && Array.isArray(data.notebook)) notebookLines = data.notebook;

      renderNotebook();
      setSaveState(data ? "ripristinato" : "‚Äî");
    }

    // START
    enableWorkUI(false);
    restoreIfAny();

  </script>
</body>
</html>
